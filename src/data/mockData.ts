import type {
  FlowInstance,
  FlowTemplate,
  MetricSnapshot,
  Notification,
  RoleDefinition,
  Task,
  TaskHistoryEntry,
  TaskProblem,
  Unit,
  User,
  WorkloadSummary,
} from '@/types/domain';

const now = new Date();
const iso = (date: Date) => date.toISOString();

const daysFromNow = (days: number) => {
  const next = new Date(now);
  next.setDate(now.getDate() + days);
  return iso(next);
};

const history = (taskId: string): TaskHistoryEntry[] => [
  {
    id: `${taskId}-h1`,
    taskId,
    action: 'Creada',
    performedBy: 'usr-admin',
    timestamp: daysFromNow(-10),
  },
  {
    id: `${taskId}-h2`,
    taskId,
    action: 'Asignada',
    performedBy: 'usr-admin',
    timestamp: daysFromNow(-9),
    notes: 'AsignaciÃ³n automÃ¡tica segÃºn carga.',
  },
];

const problems = (taskId: string, reporterId: string): TaskProblem[] => [
  {
    id: `${taskId}-p1`,
    taskId,
    reporterId,
    description: 'Dependencia externa en espera de aprobaciÃ³n.',
    createdAt: daysFromNow(-2),
    status: 'open',
  },
];

export const mockRoles: RoleDefinition[] = [
  {
    id: 'role-admin',
    key: 'ADMIN',
    name: 'Administrador',
    description: 'Configura recursos maestros y reportes ejecutivos.',
    permissions: ['users:manage', 'units:manage', 'reports:view', 'flows:approve'],
  },
  {
    id: 'role-designer',
    key: 'DESIGNER',
    name: 'DiseÃ±ador de procesos',
    description: 'Crea flujos tipo y controla su ejecuciÃ³n.',
    permissions: ['flows:design', 'flows:execute', 'tasks:monitor'],
  },
  {
    id: 'role-funcionario',
    key: 'FUNCTIONARY',
    name: 'Funcionario',
    description: 'Ejecuta tareas operativas y reporta estado.',
    permissions: ['tasks:update', 'tasks:delegate', 'tasks:problem'],
  },
];

export const mockUnits: Unit[] = [
  { id: 'unit-ops', name: 'Operaciones', parentId: null, leadId: 'usr-admin' },
  { id: 'unit-fin', name: 'Finanzas', parentId: null, leadId: 'usr-analyst' },
  { id: 'unit-ti', name: 'TecnologÃ­a', parentId: 'unit-ops', leadId: 'usr-designer' },
  { id: 'unit-field', name: 'Equipos Terreno', parentId: 'unit-ops', leadId: 'usr-func-1' },
  { id: 'unit-quality', name: 'Calidad', parentId: 'unit-ops', leadId: 'usr-func-2' },
];

export const mockUsers: User[] = [
  {
    id: 'usr-admin',
    fullName: 'Gabriela Ãlvarez',
    email: 'gabriela@processsa.com',
    roleId: 'role-admin',
    unitId: 'unit-ops',
    avatarColor: '#2dd4bf',
    workload: 35,
    lastLogin: daysFromNow(-1),
  },
  {
    id: 'usr-designer',
    fullName: 'JoaquÃ­n Ortega',
    email: 'joaquin@processsa.com',
    roleId: 'role-designer',
    unitId: 'unit-ti',
    avatarColor: '#fbbf24',
    workload: 62,
    lastLogin: daysFromNow(-2),
  },
  {
    id: 'usr-func-1',
    fullName: 'MarÃ­a LÃ³pez',
    email: 'maria@processsa.com',
    roleId: 'role-functionary',
    unitId: 'unit-field',
    avatarColor: '#60a5fa',
    workload: 78,
    lastLogin: daysFromNow(-1),
  },
  {
    id: 'usr-func-2',
    fullName: 'Luis GÃ³mez',
    email: 'luis@processsa.com',
    roleId: 'role-functionary',
    unitId: 'unit-quality',
    avatarColor: '#c084fc',
    workload: 55,
    lastLogin: daysFromNow(-3),
  },
  {
    id: 'usr-analyst',
    fullName: 'Constanza PÃ©rez',
    email: 'constanza@processsa.com',
    roleId: 'role-functionary',
    unitId: 'unit-fin',
    avatarColor: '#f87171',
    workload: 48,
    lastLogin: daysFromNow(-1),
  },
  {
    id: 'usr-auditor',
    fullName: 'Patricio Vidal',
    email: 'patricio@processsa.com',
    roleId: 'role-designer',
    unitId: 'unit-quality',
    avatarColor: '#14b8a6',
    workload: 44,
    lastLogin: daysFromNow(-4),
  },
  {
    id: 'usr-ti-dev',
    fullName: 'Valentina Rivas',
    email: 'valentina@processsa.com',
    roleId: 'role-functionary',
    unitId: 'unit-ti',
    avatarColor: '#fb7185',
    workload: 52,
    lastLogin: daysFromNow(-2),
  },
];

export const mockFlowTemplates: FlowTemplate[] = [
  {
    id: 'flow-onboarding',
    name: 'Onboarding de Cliente',
    description: 'Proceso base para habilitar un nuevo cliente en Process SA.',
    businessObjective: 'Garantizar una activaciÃ³n en 10 dÃ­as hÃ¡biles.',
    ownerId: 'usr-designer',
    lastUpdated: daysFromNow(-5),
    typicalDurationDays: 10,
    stages: [
      {
        id: 'stg-descubrimiento',
        name: 'Descubrimiento',
        description: 'Levantamiento de informaciÃ³n inicial.',
        expectedDurationDays: 2,
        ownerRole: 'DESIGNER',
        exitCriteria: 'Acta de levantamiento aprobada.',
      },
      {
        id: 'stg-diseno',
        name: 'DiseÃ±o detallado',
        description: 'Modelado de procesos futuros.',
        expectedDurationDays: 4,
        ownerRole: 'DESIGNER',
        exitCriteria: 'Modelos BPMN validados.',
      },
      {
        id: 'stg-ejecucion',
        name: 'EjecuciÃ³n piloto',
        description: 'ImplementaciÃ³n en cÃ©lulas piloto.',
        expectedDurationDays: 4,
        ownerRole: 'FUNCTIONARY',
        exitCriteria: 'Indicadores piloto dentro de umbral.',
      },
    ],
  },
  {
    id: 'flow-cierre-trimestral',
    name: 'Cierre Trimestral',
    description: 'Flujo recurrente para cierre de contratos y KPI.',
    businessObjective: 'Disponibilizar informe ejecutivo T+3.',
    ownerId: 'usr-designer',
    lastUpdated: daysFromNow(-12),
    typicalDurationDays: 14,
    stages: [
      {
        id: 'stg-preparacion',
        name: 'PreparaciÃ³n de datos',
        description: 'ConsolidaciÃ³n de fuentes.',
        expectedDurationDays: 3,
        ownerRole: 'FUNCTIONARY',
        exitCriteria: 'Dataset validado.',
      },
      {
        id: 'stg-analisis',
        name: 'AnÃ¡lisis y hallazgos',
        description: 'IdentificaciÃ³n de brechas y oportunidades.',
        expectedDurationDays: 4,
        ownerRole: 'DESIGNER',
        exitCriteria: 'Hallazgos presentados.',
      },
      {
        id: 'stg-comite',
        name: 'ComitÃ© de decisiÃ³n',
        description: 'PresentaciÃ³n a gerencia.',
        expectedDurationDays: 2,
        ownerRole: 'ADMIN',
        exitCriteria: 'Acta de aprobaciÃ³n emitida.',
      },
    ],
  },
];

export const mockFlowInstances: FlowInstance[] = [
  {
    id: 'fin-q3',
    templateId: 'flow-cierre-trimestral',
    name: 'Cierre Q3 - Cliente Andino',
    kickoffDate: daysFromNow(-15),
    dueDate: daysFromNow(2),
    ownerUnitId: 'unit-fin',
    health: 'at_risk',
    state: 'en_progreso',
    progress: 68,
    stageStatus: {
      'stg-preparacion': { status: 'completed', ownerId: 'usr-analyst', progress: 100 },
      'stg-analisis': { status: 'in_progress', ownerId: 'usr-designer', progress: 60 },
      'stg-comite': { status: 'pending', ownerId: 'usr-admin', progress: 10 },
    },
    stageStatuses: [],
  },
  {
    id: 'op-onb-998',
    templateId: 'flow-onboarding',
    name: 'Onboarding Cliente Kora',
    kickoffDate: daysFromNow(-6),
    dueDate: daysFromNow(7),
    ownerUnitId: 'unit-ops',
    health: 'on_track',
    state: 'en_progreso',
    progress: 54,
    stageStatus: {
      'stg-descubrimiento': { status: 'completed', ownerId: 'usr-designer', progress: 100 },
      'stg-diseno': { status: 'in_progress', ownerId: 'usr-designer', progress: 50 },
      'stg-ejecucion': { status: 'pending', ownerId: 'usr-func-1', progress: 5 },
    },
    stageStatuses: [],
  },
];

export const mockTasks: Task[] = [
  {
    id: 'task-100',
    title: 'DiseÃ±ar flujo de aprobaciÃ³n documental',
    description: 'Actualizar flujo con versiones y reglas de negocio.',
    status: 'in_progress',
    ownerId: 'usr-designer',
    assignerId: 'usr-admin',
    flowInstanceId: 'op-onb-998',
    priority: 'high',
    deadline: daysFromNow(5),
    createdAt: daysFromNow(-4),
    updatedAt: daysFromNow(-1),
    progress: 45,
    durationDays: 10,
    dependencies: [],
    relatedTaskIds: ['task-101'],
    tags: ['flujo', 'documental'],
    allowRejection: true,
    problems: [],
    history: history('task-100'),
    subTasks: [
      {
        id: 'task-100-st1',
        title: 'Entrevistar al Ã¡rea legal',
        status: 'completed',
        assigneeId: 'usr-designer',
        progress: 100,
        deadline: daysFromNow(-1),
      },
      {
        id: 'task-100-st2',
        title: 'Redactar matriz RACI',
        status: 'pending',
        assigneeId: 'usr-designer',
        progress: 20,
        deadline: daysFromNow(3),
      },
    ],
  },
  {
    id: 'task-101',
    title: 'Configurar tablero global de indicadores',
    description: 'Incluir semÃ¡foro y alertas automÃ¡ticas.',
    status: 'pending',
    ownerId: 'usr-designer',
    assignerId: 'usr-admin',
    priority: 'medium',
    deadline: daysFromNow(9),
    createdAt: daysFromNow(-2),
    updatedAt: daysFromNow(-2),
    progress: 10,
    durationDays: 15,
    dependencies: ['task-100'],
    relatedTaskIds: ['task-100'],
    tags: ['tablero', 'indicadores'],
    allowRejection: true,
    problems: [],
    history: history('task-101'),
    subTasks: [],
  },
  {
    id: 'task-200',
    title: 'Auditar entregables del piloto',
    description: 'RevisiÃ³n cruzada con checklist de calidad.',
    status: 'blocked',
    ownerId: 'usr-func-2',
    assignerId: 'usr-designer',
    priority: 'critical',
    deadline: daysFromNow(-1),
    createdAt: daysFromNow(-7),
    updatedAt: daysFromNow(-1),
    progress: 30,
    durationDays: 7,
    dependencies: ['task-100'],
    relatedTaskIds: [],
    tags: ['calidad'],
    allowRejection: false,
    problems: problems('task-200', 'usr-func-2'),
    history: history('task-200'),
    subTasks: [],
  },
  {
    id: 'task-201',
    title: 'Consolidar reporte financiero trimestral',
    description: 'Cruzar ERP + CRM + campo.',
    status: 'in_progress',
    ownerId: 'usr-analyst',
    assignerId: 'usr-admin',
    priority: 'high',
    deadline: daysFromNow(2),
    createdAt: daysFromNow(-5),
    updatedAt: daysFromNow(-1),
    progress: 66,
    durationDays: 9,
    dependencies: [],
    relatedTaskIds: [],
    tags: ['finanzas'],
    allowRejection: true,
    problems: [],
    history: history('task-201'),
    subTasks: [],
  },
  {
    id: 'task-300',
    title: 'Implementar notificaciones push',
    description: 'Conectar con servicio de mensajerÃ­a mÃ³vil.',
    status: 'pending',
    ownerId: 'usr-ti-dev',
    assignerId: 'usr-designer',
    priority: 'medium',
    deadline: daysFromNow(12),
    createdAt: daysFromNow(-1),
    updatedAt: daysFromNow(-1),
    progress: 5,
    durationDays: 14,
    dependencies: [],
    relatedTaskIds: [],
    tags: ['tecnologÃ­a'],
    allowRejection: true,
    problems: [],
    history: history('task-300'),
    subTasks: [],
  },
  {
    id: 'task-310',
    title: 'Capacitar a usuarios finales',
    description: 'Sesiones virtuales + manual PDF.',
    status: 'pending',
    ownerId: 'usr-func-1',
    assignerId: 'usr-admin',
    priority: 'low',
    deadline: daysFromNow(15),
    createdAt: daysFromNow(-3),
    updatedAt: daysFromNow(-2),
    progress: 0,
    durationDays: 12,
    dependencies: [],
    relatedTaskIds: [],
    tags: ['capacitaciÃ³n'],
    allowRejection: true,
    problems: [],
    history: history('task-310'),
    subTasks: [],
  },
].filter(Boolean) as Task[];

export const mockNotifications: Notification[] = [
  {
    id: 'ntf-1',
    message: 'Tarea "Auditar entregables del piloto" lleva 1 dÃ­a de atraso.',
    createdAt: daysFromNow(-1),
    severity: 'danger',
    link: '/app/tasks/board',
  },
  {
    id: 'ntf-2',
    message: 'El flujo "Cierre Q3 - Cliente Andino" presenta riesgo medio.',
    createdAt: daysFromNow(-2),
    severity: 'warning',
    link: '/app/designer/flows',
  },
  {
    id: 'ntf-3',
    message: 'Nueva solicitud de rol para el equipo de calidad.',
    createdAt: daysFromNow(-3),
    severity: 'info',
    link: '/app/admin/users',
  },
];

export const mockWorkload: WorkloadSummary[] = [
  { userId: 'usr-func-1', assigned: 8, inProgress: 4, blocked: 1, overdue: 0, capacity: 10 },
  { userId: 'usr-func-2', assigned: 6, inProgress: 3, blocked: 2, overdue: 1, capacity: 8 },
  { userId: 'usr-analyst', assigned: 5, inProgress: 2, blocked: 0, overdue: 0, capacity: 7 },
  { userId: 'usr-designer', assigned: 7, inProgress: 5, blocked: 0, overdue: 0, capacity: 9 },
];

export const mockMetrics: MetricSnapshot[] = [
  { date: daysFromNow(-14), completed: 42, delayed: 8, reassigned: 2 },
  { date: daysFromNow(-7), completed: 51, delayed: 6, reassigned: 5 },
  { date: daysFromNow(-3), completed: 58, delayed: 5, reassigned: 4 },
  { date: daysFromNow(-1), completed: 60, delayed: 4, reassigned: 3 },
];
